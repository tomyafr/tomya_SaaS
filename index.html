<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOMYA - Gestion Auto-√âcoles v7.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-darker: #050508;
            --bg-card: #0f0f17;
            --bg-card-hover: #14141f;
            --border: #1a1a2e;
            --border-light: #252540;
            --text-primary: #ffffff;
            --text-secondary: #9898b0;
            --text-muted: #5c5c75;
            --accent: #00d4ff;
            --accent-glow: #00d4ff;
            --accent-secondary: #0ea5e9;
            --accent-light: rgba(0, 212, 255, 0.1);
            --accent-border: rgba(0, 212, 255, 0.3);
            --success: #10b981;
            --success-light: rgba(16, 185, 129, 0.1);
            --warning: #f59e0b;
            --warning-light: rgba(245, 158, 11, 0.1);
            --danger: #ef4444;
            --danger-light: rgba(239, 68, 68, 0.1);
            --purple: #8b5cf6;
            --purple-light: rgba(139, 92, 246, 0.1);
            --pink: #ec4899;
            --pink-light: rgba(236, 72, 153, 0.1);
            --sidebar-width: 260px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-dark); color: var(--text-primary); line-height: 1.6; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }

        .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--bg-darker); position: relative; }
        .login-screen::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 800px; height: 800px; background: radial-gradient(circle, rgba(0, 212, 255, 0.15) 0%, transparent 60%); pointer-events: none; }
        .login-card { background: var(--bg-card); padding: 48px; border-radius: 24px; border: 1px solid var(--border); width: 100%; max-width: 420px; position: relative; z-index: 1; }
        .login-logo { text-align: center; margin-bottom: 40px; }
        .login-logo h1 { font-size: 42px; font-weight: 800; letter-spacing: -1px; }
        .login-logo h1 span { color: var(--accent); text-shadow: 0 0 40px var(--accent-glow); }
        .login-logo p { color: var(--text-secondary); margin-top: 8px; font-size: 14px; }
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px 18px; background: var(--bg-darker); border: 1px solid var(--border); border-radius: 12px; font-size: 15px; color: var(--text-primary); transition: all 0.3s; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 14px 28px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%); color: var(--bg-dark); box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(0, 212, 255, 0.5); }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent-border); }
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white; }
        .btn-danger { background: var(--danger-light); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-warning { background: var(--warning-light); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        .btn-xs { padding: 6px 12px; font-size: 12px; }
        .login-error { background: var(--danger-light); color: var(--danger); padding: 14px; border-radius: 12px; margin-bottom: 20px; display: none; border: 1px solid rgba(239, 68, 68, 0.3); }

        .app-container { display: none; min-height: 100vh; }
        .app-container.active { display: flex; }

        .sidebar { width: var(--sidebar-width); background: var(--bg-card); border-right: 1px solid var(--border); position: fixed; top: 0; left: 0; height: 100vh; padding: 24px 0; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-logo { padding: 0 24px 32px; border-bottom: 1px solid var(--border); margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .sidebar-logo h1 { font-size: 26px; font-weight: 800; }
        .sidebar-logo h1 span { color: var(--accent); text-shadow: 0 0 20px var(--accent-glow); }
        .sidebar-nav { flex: 1; padding: 0 16px; overflow-y: auto; }
        .nav-section-title { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; padding: 0 12px; margin-bottom: 12px; margin-top: 24px; }
        .nav-section-title:first-child { margin-top: 0; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; color: var(--text-secondary); margin-bottom: 4px; cursor: pointer; transition: all 0.2s; font-weight: 500; font-size: 14px; user-select: none; }
        .nav-item:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-light); color: var(--accent); border: 1px solid var(--accent-border); }
        .nav-item svg { width: 20px; height: 20px; flex-shrink: 0; pointer-events: none; }
        .sidebar-footer { padding: 20px 16px; border-top: 1px solid var(--border); margin: 0 16px; }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-darker); border-radius: 12px; margin-bottom: 12px; }
        .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--bg-dark); }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-role { font-size: 12px; color: var(--text-muted); }
        .logout-btn { width: 100%; background: transparent; color: var(--text-secondary); border: 1px solid var(--border); padding: 10px; border-radius: 10px; cursor: pointer; font-size: 13px; font-family: inherit; }
        .logout-btn:hover { background: var(--danger-light); color: var(--danger); }

        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 32px 40px; min-height: 100vh; background: var(--bg-darker); }
        .page { display: none; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        .page.active { display: block; }
        .page-header { margin-bottom: 32px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; }
        .page-title { font-size: 32px; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.5px; }
        .page-subtitle { color: var(--text-secondary); font-size: 15px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); padding: 24px; border-radius: 16px; border: 1px solid var(--border); position: relative; overflow: hidden; transition: all 0.3s; cursor: pointer; }
        .stat-card:hover { transform: translateY(-4px); border-color: var(--accent-border); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .stat-card.primary::before { background: linear-gradient(90deg, var(--accent), var(--accent-secondary)); }
        .stat-card.success::before { background: linear-gradient(90deg, var(--success), #34d399); }
        .stat-card.warning::before { background: linear-gradient(90deg, var(--warning), #fbbf24); }
        .stat-card.purple::before { background: linear-gradient(90deg, var(--purple), #a78bfa); }
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stat-card.primary .stat-icon { background: var(--accent-light); color: var(--accent); }
        .stat-card.success .stat-icon { background: var(--success-light); color: var(--success); }
        .stat-card.warning .stat-icon { background: var(--warning-light); color: var(--warning); }
        .stat-card.purple .stat-icon { background: var(--purple-light); color: var(--purple); }
        .stat-value { font-size: 36px; font-weight: 800; letter-spacing: -2px; line-height: 1; }
        .stat-label { color: var(--text-secondary); font-size: 14px; margin-top: 8px; font-weight: 500; }

        .card { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); margin-bottom: 24px; }
        .card-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .card-title { font-size: 16px; font-weight: 700; }
        .card-body { padding: 24px; }
        .result-box { margin-top: 24px; padding: 20px; border-radius: 12px; display: none; border: 1px solid; }
        .result-box.success { background: var(--success-light); border-color: rgba(16, 185, 129, 0.3); color: var(--success); display: block; }
        .result-box.error { background: var(--danger-light); border-color: rgba(239, 68, 68, 0.3); color: var(--danger); display: block; }

        .recorder-container { text-align: center; padding: 40px; }
        .recorder-warning { background: var(--warning-light); border: 1px solid rgba(245, 158, 11, 0.3); color: var(--warning); padding: 16px; border-radius: 12px; margin-bottom: 24px; display: none; }
        .recorder-warning.active { display: block; }
        .caller-select { display: flex; gap: 12px; justify-content: center; margin-bottom: 24px; }
        .caller-btn { padding: 12px 24px; border-radius: 10px; border: 2px solid var(--border); background: var(--bg-darker); color: var(--text-secondary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .caller-btn.active { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
        .caller-btn.mathieu.active { border-color: var(--purple); background: var(--purple-light); color: var(--purple); }
        .recorder-btn { width: 120px; height: 120px; border-radius: 50%; border: 2px solid var(--border); background: var(--bg-darker); cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 48px; }
        .recorder-btn:hover { border-color: var(--accent); }
        .recorder-btn.recording { background: var(--danger); border-color: var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .recorder-status { font-size: 16px; color: var(--text-secondary); margin-bottom: 8px; }
        .recorder-time { font-size: 48px; font-weight: 300; font-variant-numeric: tabular-nums; }
        .recorder-actions { margin-top: 32px; display: flex; gap: 16px; justify-content: center; }
        .recorder-ecole-info { background: var(--accent-light); border: 1px solid var(--accent-border); padding: 12px 20px; border-radius: 10px; margin-bottom: 20px; display: inline-block; }
        .recorder-ecole-info span { color: var(--accent); font-weight: 600; }

        .filters-bar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-box input { width: 100%; padding: 12px 16px 12px 44px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; font-size: 14px; color: var(--text-primary); }
        .search-box input:focus { outline: none; border-color: var(--accent); }
        .search-box .icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .filter-select { padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; font-size: 14px; color: var(--text-primary); min-width: 140px; cursor: pointer; font-family: inherit; }

        .autocomplete-wrapper { position: relative; }
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; margin-top: 4px; }
        .autocomplete-list.active { display: block; }
        .autocomplete-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 14px; }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:hover { background: var(--bg-card-hover); }
        .autocomplete-item .sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

        .auto-ecoles-grid { display: grid; gap: 16px; }
        .ecole-card { background: var(--bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--border); transition: all 0.3s; cursor: pointer; }
        .ecole-card:hover { border-color: var(--accent-border); transform: translateY(-2px); }
        .ecole-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .ecole-name { font-size: 18px; font-weight: 700; }
        .ecole-date { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .ecole-caller { font-size: 11px; color: var(--accent); margin-top: 2px; }
        .ecole-status { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-appele { background: var(--success-light); color: var(--success); }
        .status-non-appele { background: var(--bg-darker); color: var(--text-muted); }
        .status-interesse { background: var(--accent-light); color: var(--accent); }
        .status-a-rappeler { background: var(--purple-light); color: var(--purple); }
        .ecole-info { display: grid; gap: 8px; margin-bottom: 16px; }
        .ecole-info-item { display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-secondary); }
        .ecole-tags { display: flex; gap: 8px; flex-wrap: wrap; }
        .ecole-tag { padding: 6px 12px; background: var(--bg-darker); border-radius: 8px; font-size: 12px; color: var(--text-secondary); }

        .calendar-container { display: grid; grid-template-columns: 1fr 380px; gap: 24px; }
        @media (max-width: 1200px) { .calendar-container { grid-template-columns: 1fr; } }
        .calendar-grid { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; }
        .calendar-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .calendar-nav { display: flex; gap: 8px; }
        .calendar-nav button { width: 40px; height: 40px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-darker); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; }
        .calendar-nav button:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
        .calendar-month { font-size: 18px; font-weight: 700; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg-darker); }
        .calendar-weekday { text-align: center; font-size: 12px; font-weight: 600; color: var(--text-muted); }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); padding: 16px; gap: 8px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; transition: all 0.2s; font-size: 14px; font-weight: 500; position: relative; }
        .calendar-day:hover { background: var(--bg-card-hover); }
        .calendar-day.other-month { color: var(--text-muted); opacity: 0.5; }
        .calendar-day.today { background: var(--accent-light); color: var(--accent); border: 1px solid var(--accent-border); }
        .calendar-day.selected { background: var(--accent); color: var(--bg-dark); }
        .calendar-day.has-event::after { content: ''; width: 6px; height: 6px; background: var(--success); border-radius: 50%; position: absolute; bottom: 6px; }
        .events-sidebar { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); }
        .events-header { padding: 20px 24px; border-bottom: 1px solid var(--border); }
        .events-date { font-size: 16px; font-weight: 700; }
        .events-count { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
        .events-list { padding: 16px; max-height: 450px; overflow-y: auto; }
        .event-card { background: var(--bg-darker); border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 3px solid var(--accent); }
        .event-card:last-child { margin-bottom: 0; }
        .event-card.rdv { border-left-color: var(--success); }
        .event-card.rappel { border-left-color: var(--warning); }
        .event-time { font-size: 13px; font-weight: 600; color: var(--accent); margin-bottom: 8px; }
        .event-card.rdv .event-time { color: var(--success); }
        .event-card.rappel .event-time { color: var(--warning); }
        .event-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .event-desc { font-size: 13px; color: var(--text-secondary); }
        .event-actions { margin-top: 12px; }
        .events-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .add-event-btn { width: calc(100% - 32px); margin: 16px; padding: 12px; background: var(--accent-light); border: 1px dashed var(--accent-border); border-radius: 10px; color: var(--accent); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: inherit; }
        .add-event-btn:hover { background: var(--accent); color: var(--bg-dark); border-style: solid; }

        .historique-grid { display: grid; gap: 16px; }
        .appel-card { background: var(--bg-card); border-radius: 16px; padding: 20px; border: 1px solid var(--border); transition: all 0.3s; cursor: pointer; }
        .appel-card:hover { border-color: var(--accent-border); }
        .appel-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .appel-ecole { font-size: 16px; font-weight: 700; }
        .appel-date { font-size: 12px; color: var(--text-muted); }
        .appel-meta { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 12px; }
        .appel-meta-item { font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .appel-notes { font-size: 14px; color: var(--text-secondary); line-height: 1.6; }
        .appel-badge { padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .appel-badge.interesse { background: var(--success-light); color: var(--success); }
        .appel-badge.non-interesse { background: var(--danger-light); color: var(--danger); }
        .appel-badge.partiel { background: var(--warning-light); color: var(--warning); }

        .notes-container { display: grid; gap: 16px; }
        .note-card { background: var(--bg-darker); border: 1px solid var(--border); border-radius: 12px; padding: 20px; border-left: 4px solid var(--border); }
        .note-card.type-tache { border-left-color: var(--danger); background: linear-gradient(90deg, var(--danger-light) 0%, var(--bg-darker) 20%); }
        .note-card.type-idee { border-left-color: var(--warning); background: linear-gradient(90deg, var(--warning-light) 0%, var(--bg-darker) 20%); }
        .note-card.type-message { border-left-color: var(--accent); background: linear-gradient(90deg, var(--accent-light) 0%, var(--bg-darker) 20%); }
        .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .note-author { display: flex; align-items: center; gap: 8px; }
        .note-avatar { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; }
        .note-avatar.tom { background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); color: var(--bg-dark); }
        .note-avatar.mathieu { background: linear-gradient(135deg, var(--purple), #a78bfa); color: white; }
        .note-avatar.both { background: linear-gradient(135deg, var(--success), #34d399); color: white; }
        .note-avatar.claude { background: linear-gradient(135deg, var(--pink), #f472b6); color: white; }
        .note-meta { display: flex; align-items: center; gap: 12px; }
        .note-type { font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: 600; text-transform: uppercase; }
        .note-type.tache { background: var(--danger-light); color: var(--danger); }
        .note-type.idee { background: var(--warning-light); color: var(--warning); }
        .note-type.message { background: var(--accent-light); color: var(--accent); }
        .note-name { font-size: 13px; font-weight: 600; }
        .note-date { font-size: 12px; color: var(--text-muted); }
        .note-content { font-size: 14px; color: var(--text-secondary); line-height: 1.6; }
        .note-actions { margin-top: 12px; display: flex; gap: 8px; }
        .note-form { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
        .note-form textarea { min-height: 100px; resize: vertical; }
        .note-form-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; flex-wrap: wrap; gap: 12px; }
        .assignee-select, .type-select { display: flex; gap: 8px; flex-wrap: wrap; }
        .assignee-btn, .type-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-darker); color: var(--text-secondary); font-size: 13px; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .assignee-btn.active { border-color: var(--accent-border); background: var(--accent-light); color: var(--accent); }
        .assignee-btn.active.mathieu { border-color: rgba(139, 92, 246, 0.3); background: var(--purple-light); color: var(--purple); }
        .assignee-btn.active.both { border-color: rgba(16, 185, 129, 0.3); background: var(--success-light); color: var(--success); }
        .assignee-btn.active.claude { border-color: rgba(236, 72, 153, 0.3); background: var(--pink-light); color: var(--pink); }
        .type-btn.active.tache { border-color: rgba(239, 68, 68, 0.3); background: var(--danger-light); color: var(--danger); }
        .type-btn.active.idee { border-color: rgba(245, 158, 11, 0.3); background: var(--warning-light); color: var(--warning); }
        .type-btn.active.message { border-color: var(--accent-border); background: var(--accent-light); color: var(--accent); }

        .script-container { max-width: 900px; }
        .script-section { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); margin-bottom: 24px; overflow: hidden; }
        .script-section-header { padding: 16px 24px; background: var(--bg-darker); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .script-section-header h3 { font-size: 16px; font-weight: 700; flex: 1; }
        .script-section-content { padding: 24px; display: none; }
        .script-section.open .script-section-content { display: block; }
        .script-quote { background: var(--accent-light); border-left: 4px solid var(--accent); padding: 16px 20px; border-radius: 0 12px 12px 0; margin: 16px 0; font-style: italic; }
        .script-quote.alt { background: var(--purple-light); border-left-color: var(--purple); }
        .script-tip { background: var(--warning-light); border: 1px solid rgba(245, 158, 11, 0.3); padding: 16px; border-radius: 12px; margin: 16px 0; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border-radius: 20px; border: 1px solid var(--border); width: 100%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg-card); z-index: 10; border-radius: 20px 20px 0 0; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .modal-close { width: 40px; height: 40px; border: none; background: var(--bg-darker); border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 20px; }
        .modal-close:hover { background: var(--danger-light); color: var(--danger); }
        .modal-body { padding: 24px; }
        .detail-section { margin-bottom: 28px; }
        .detail-section:last-child { margin-bottom: 0; }
        .detail-section-title { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .detail-item { display: flex; flex-direction: column; gap: 6px; }
        .detail-label { font-size: 12px; color: var(--text-muted); }
        .detail-value { font-size: 15px; }
        .transcription-box { background: var(--bg-darker); padding: 20px; border-radius: 12px; font-size: 14px; line-height: 1.8; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }

        .analysis-result { display: none; margin-top: 40px; }
        .analysis-result.active { display: block; }
        .analysis-header { display: flex; align-items: center; gap: 20px; padding: 24px; background: var(--accent-light); border: 1px solid var(--accent-border); border-radius: 16px; margin-bottom: 24px; }
        .analysis-icon { width: 56px; height: 56px; background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .analysis-title { font-size: 22px; font-weight: 700; }
        .analysis-subtitle { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .analysis-section { background: var(--bg-darker); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .analysis-section-title { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; }
        .rdv-badge { display: inline-flex; align-items: center; gap: 8px; background: var(--success-light); border: 1px solid rgba(16, 185, 129, 0.3); color: var(--success); padding: 12px 16px; border-radius: 10px; margin-top: 16px; cursor: pointer; }
        .rdv-badge:hover { background: var(--success); color: white; }

        .loading { display: flex; align-items: center; justify-content: center; padding: 60px; }
        .spinner { width: 44px; height: 44px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px; color: var(--text-secondary); }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; padding: 20px; }
            .detail-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo"><h1>TOMYA<span>.</span></h1><p>Gestion des Auto-√âcoles v7.1</p></div>
            <div class="login-error" id="loginError">Mot de passe incorrect</div>
            <form id="loginForm">
                <div class="form-group"><label>Mot de passe</label><input type="password" id="passwordInput" placeholder="Entrez votre mot de passe" required></div>
                <button type="submit" class="btn btn-primary" style="width:100%">Se connecter</button>
            </form>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon"><img src="Chatbot_TOMYA_icone.png" alt="TOMYA" style="width:100%;height:100%;border-radius:10px;object-fit:cover;"></div>
                <h1>TOMYA<span>.</span></h1>
            </div>
            <nav class="sidebar-nav" id="sidebarNav">
                <div class="nav-section-title">Menu principal</div>
                <div class="nav-item active" onclick="navigateTo('dashboard')">üìä <span>Dashboard</span></div>
                <div class="nav-section-title">Outils</div>
                <div class="nav-item" onclick="navigateTo('scraping')">üîç <span>Scraping</span></div>
                <div class="nav-item" onclick="navigateTo('recorder')">üéôÔ∏è <span>Enregistrement</span></div>
                <div class="nav-item" onclick="navigateTo('script')">üìÑ <span>Script Appel</span></div>
                <div class="nav-item" onclick="navigateTo('agenda')">üìÖ <span>Agenda</span></div>
                <div class="nav-section-title">Donn√©es</div>
                <div class="nav-item" onclick="navigateTo('autoecoles')">üè´ <span>Auto-√âcoles</span></div>
                <div class="nav-item" onclick="navigateTo('historique')">üìû <span>Historique Appels</span></div>
                <div class="nav-item" onclick="navigateTo('notes')">üìù <span>Notes</span></div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info"><div class="user-avatar">T</div><div><div class="user-name">Tom</div><div class="user-role">Admin TOMYA</div></div></div>
                <button type="button" class="logout-btn" onclick="logout()">Se d√©connecter</button>
            </div>
        </aside>

        <main class="main-content">
            <!-- DASHBOARD -->
            <div class="page active" id="page-dashboard">
                <div class="page-header"><div><h1 class="page-title">Dashboard</h1><p class="page-subtitle">Vue d'ensemble de vos auto-√©coles</p></div></div>
                <div class="stats-grid">
                    <div class="stat-card primary" onclick="navigateWithFilter('all')"><div class="stat-header"><div class="stat-icon">üè´</div></div><div class="stat-value" id="statTotal">-</div><div class="stat-label">Total Auto-√âcoles</div></div>
                    <div class="stat-card success" onclick="navigateWithFilter('appele')"><div class="stat-header"><div class="stat-icon">üìû</div></div><div class="stat-value" id="statAppeles">-</div><div class="stat-label">Appel√©es</div></div>
                    <div class="stat-card warning" onclick="navigateWithFilter('interesse')"><div class="stat-header"><div class="stat-icon">‚≠ê</div></div><div class="stat-value" id="statInteresses">-</div><div class="stat-label">Int√©ress√©es</div></div>
                    <div class="stat-card purple" onclick="navigateWithFilter('a-rappeler')"><div class="stat-header"><div class="stat-icon">‚è∞</div></div><div class="stat-value" id="statARappeler">-</div><div class="stat-label">√Ä Rappeler</div></div>
                </div>
                <div class="card"><div class="card-header"><h3 class="card-title">Actions Rapides</h3></div><div class="card-body"><div style="display: flex; gap: 12px; flex-wrap: wrap;"><button type="button" class="btn btn-primary" onclick="navigateTo('scraping')">üîç Scraping</button><button type="button" class="btn btn-success" onclick="navigateTo('recorder')">üéôÔ∏è Enregistrer</button><button type="button" class="btn btn-warning" onclick="navigateTo('script')">üìÑ Script</button><button type="button" class="btn btn-secondary" onclick="navigateTo('agenda')">üìÖ Agenda</button><button type="button" class="btn btn-secondary" onclick="loadAutoEcoles()">üîÑ Rafra√Æchir</button></div></div></div>
            </div>

            <!-- SCRAPING -->
            <div class="page" id="page-scraping">
                <div class="page-header"><div><h1 class="page-title">Scraping Google Maps</h1><p class="page-subtitle">Rechercher des auto-√©coles</p></div></div>
                <div class="card"><div class="card-body">
                    <div style="max-width: 500px;">
                        <div class="form-group"><label>Ville ou Zone</label><input type="text" id="scrapingVille" placeholder="Ex: Lyon, Marseille, Paris..."></div>
                        <div class="form-group"><label>Nombre maximum</label><input type="number" id="scrapingMax" value="20" min="1" max="100"></div>
                        <button type="button" class="btn btn-primary" id="scrapingBtn" onclick="lancerScraping()">üîç Lancer le Scraping</button>
                    </div>
                    <div class="result-box" id="scrapingResult"></div>
                </div></div>
            </div>

            <!-- RECORDER -->
            <div class="page" id="page-recorder">
                <div class="page-header"><div><h1 class="page-title">Enregistrement d'Appel</h1><p class="page-subtitle">Analyse IA automatique</p></div></div>
                <div class="card"><div class="card-body">
                    <div class="recorder-container">
                        <div class="recorder-ecole-info" id="recorderEcoleInfo" style="display: none;">üìû Appel pour : <span id="recorderEcoleName"></span></div>
                        <div class="recorder-warning" id="recorderWarning">‚ö†Ô∏è Ne quittez pas cette page pendant l'enregistrement !</div>
                        <div style="margin-bottom: 24px;"><label style="font-size: 14px; color: var(--text-secondary); display: block; margin-bottom: 12px;">Qui appelle ?</label>
                            <div class="caller-select">
                                <button type="button" class="caller-btn tom active" onclick="selectCaller('Tom', this)">üë®‚Äçüíº Tom</button>
                                <button type="button" class="caller-btn mathieu" onclick="selectCaller('Mathieu', this)">üë®‚Äçüíº Mathieu</button>
                            </div>
                        </div>
                        <button type="button" class="recorder-btn" id="recorderBtn" onclick="toggleRecording()">üéôÔ∏è</button>
                        <div class="recorder-status" id="recorderStatus">Cliquez pour commencer</div>
                        <div class="recorder-time" id="recorderTime">00:00</div>
                        <div class="recorder-actions" id="recorderActions" style="display: none;"><button type="button" class="btn btn-danger" onclick="cancelRecording()">Annuler</button><button type="button" class="btn btn-success" onclick="sendRecording()">Envoyer pour Analyse</button></div>
                    </div>
                </div></div>
                <div class="analysis-result" id="analysisResult"></div>
            </div>

            <!-- SCRIPT -->
            <div class="page" id="page-script">
                <div class="page-header"><div><h1 class="page-title">üìû Script Cold Call</h1><p class="page-subtitle">Auto-√âcoles | TOMYA</p></div></div>
                <div class="script-container">
                    <div class="script-section open">
                        <div class="script-section-header" onclick="this.parentElement.classList.toggle('open')">
                            <span>üéØ</span><h3>Objectif</h3><span>‚ñº</span>
                        </div>
                        <div class="script-section-content">
                            <p style="font-size: 18px; font-weight: 600;">Obtenir un RDV de 15-30 min pour pr√©senter les solutions d'automatisation.</p>
                            <div class="script-tip" style="margin-top: 20px;"><strong>üìã Structure (2-3 min max)</strong><br>1. Accroche (10s) ‚Üí 2. Qualification (20s) ‚Üí 3. Proposition (30s) ‚Üí 4. Prise RDV (30s) ‚Üí 5. Confirmation (10s)</div>
                        </div>
                    </div>
                    <div class="script-section">
                        <div class="script-section-header" onclick="this.parentElement.classList.toggle('open')"><span>1Ô∏è‚É£</span><h3>Accroche (10 sec)</h3><span>‚ñº</span></div>
                        <div class="script-section-content">
                            <div class="script-quote">"Bonjour [Pr√©nom], c'est [Ton pr√©nom] de TOMYA. Je vous appelle parce qu'on aide les auto-√©coles √† r√©cup√©rer du temps sur leur administratif. Vous avez 30 secondes ?"</div>
                            <div class="script-quote alt">"Bonjour, c'est [Ton pr√©nom] de TOMYA. Je travaille avec des auto-√©coles de [Ville] sur l'automatisation. Vous avez 30 secondes ?"</div>
                        </div>
                    </div>
                    <div class="script-section">
                        <div class="script-section-header" onclick="this.parentElement.classList.toggle('open')"><span>2Ô∏è‚É£</span><h3>Qualification (20 sec)</h3><span>‚ñº</span></div>
                        <div class="script-section-content">
                            <div class="script-quote">"Parfait. Question rapide : les rappels de le√ßons, les relances d'√©l√®ves qui ont disparu, les confirmations de rendez-vous... c'est vous qui g√©rez √ßa √† la main ou vous avez un syst√®me ?"</div>
                            <div class="script-tip">üí° √âcouter la r√©ponse ‚Üí Noter mentalement le pain point</div>
                        </div>
                    </div>
                    <div class="script-section">
                        <div class="script-section-header" onclick="this.parentElement.classList.toggle('open')"><span>3Ô∏è‚É£</span><h3>Proposition de valeur (30 sec)</h3><span>‚ñº</span></div>
                        <div class="script-section-content">
                            <p><strong>S'il g√®re √† la main :</strong></p>
                            <div class="script-quote">"OK je comprends. Nous ce qu'on fait, c'est qu'on automatise tout √ßa. Vos √©l√®ves re√ßoivent leurs rappels par WhatsApp automatiquement, les absents sont relanc√©s sans lever le petit doigt, et vous r√©cup√©rez 5-10h par semaine."</div>
                        </div>
                    </div>
                    <div class="script-section">
                        <div class="script-section-header" onclick="this.parentElement.classList.toggle('open')"><span>4Ô∏è‚É£</span><h3>Prise de RDV (30 sec)</h3><span>‚ñº</span></div>
                        <div class="script-section-content">
                            <div class="script-quote">"Ce que je vous propose, c'est qu'on prenne 15 minutes pour que je vous montre concr√®tement. Pas de blabla commercial. Vous √™tes plut√¥t dispo d√©but ou fin de semaine ?"</div>
                        </div>
                    </div>
                    <div class="script-section">
                        <div class="script-section-header" onclick="this.parentElement.classList.toggle('open')"><span>üî•</span><h3>R√©ponses aux Objections</h3><span>‚ñº</span></div>
                        <div class="script-section-content">
                            <h4 style="color: var(--danger);">‚ùå "Je n'ai pas le temps"</h4>
                            <div class="script-quote">"Justement, c'est 15 minutes pour en gagner 10 heures par semaine. Jeudi 14h √ßa passe ?"</div>
                            <h4 style="color: var(--danger); margin-top:20px">‚ùå "√áa ne m'int√©resse pas"</h4>
                            <div class="script-quote">"OK, je peux vous demander ce qui ne vous int√©resse pas ? C'est le fait d'automatiser ou c'est autre chose ?"</div>
                            <h4 style="color: var(--danger); margin-top:20px">‚ùå "C'est combien ?"</h4>
                            <div class="script-quote">"√áa d√©pend de vos besoins. Mais nos clients r√©cup√®rent leur investissement d√®s le premier mois. On regarde √ßa ensemble [JOUR] ?"</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AGENDA -->
            <div class="page" id="page-agenda">
                <div class="page-header"><div><h1 class="page-title">Agenda</h1><p class="page-subtitle">G√©rez vos rendez-vous et rappels</p></div></div>
                <div class="calendar-container">
                    <div class="calendar-grid">
                        <div class="calendar-header">
                            <div class="calendar-nav">
                                <button type="button" id="btnPrevMonth">&lt;</button>
                                <button type="button" id="btnNextMonth">&gt;</button>
                            </div>
                            <div class="calendar-month" id="calendarMonth">Janvier 2026</div>
                            <button type="button" class="btn btn-sm btn-secondary" id="btnToday">Aujourd'hui</button>
                        </div>
                        <div class="calendar-weekdays"><div class="calendar-weekday">Lun</div><div class="calendar-weekday">Mar</div><div class="calendar-weekday">Mer</div><div class="calendar-weekday">Jeu</div><div class="calendar-weekday">Ven</div><div class="calendar-weekday">Sam</div><div class="calendar-weekday">Dim</div></div>
                        <div class="calendar-days" id="calendarDays"></div>
                    </div>
                    <div class="events-sidebar">
                        <div class="events-header"><div class="events-date" id="eventsDate">S√©lectionnez un jour</div><div class="events-count" id="eventsCount"></div></div>
                        <div class="events-list" id="eventsList"><div class="events-empty">S√©lectionnez un jour</div></div>
                        <button type="button" class="add-event-btn" onclick="openAddEventModal()">+ Ajouter un RDV</button>
                    </div>
                </div>
            </div>

            <!-- AUTO-ECOLES -->
            <div class="page" id="page-autoecoles">
                <div class="page-header"><div><h1 class="page-title">Auto-√âcoles</h1><p class="page-subtitle">Liste compl√®te</p></div></div>
                <div class="filters-bar">
                    <div class="search-box autocomplete-wrapper">
                        <span class="icon">üîç</span>
                        <input type="text" id="searchInput" placeholder="Rechercher une auto-√©cole..." oninput="handleSearchInput(this)">
                        <div class="autocomplete-list" id="searchAutocomplete"></div>
                    </div>
                    <select class="filter-select" id="filterStatus" onchange="applyFilters()"><option value="">Tous statuts</option><option value="appele">Appel√©es</option><option value="non-appele">Non appel√©es</option></select>
                    <select class="filter-select" id="filterInteret" onchange="applyFilters()"><option value="">Tous int√©r√™ts</option><option value="Oui">Int√©ress√©es</option><option value="Partiellement">Partiellement</option><option value="Non">Pas int√©ress√©es</option></select>
                    <select class="filter-select" id="filterVille" onchange="applyFilters()"><option value="">Toutes villes</option></select>
                    <select class="filter-select" id="filterCaller" onchange="applyFilters()"><option value="">Tous appelants</option><option value="Tom">Tom</option><option value="Mathieu">Mathieu</option></select>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="resetFilters()">üîÑ R√©initialiser</button>
                </div>
                <div class="auto-ecoles-grid" id="autoEcolesGrid"><div class="loading"><div class="spinner"></div></div></div>
            </div>

            <!-- HISTORIQUE APPELS -->
            <div class="page" id="page-historique">
                <div class="page-header"><div><h1 class="page-title">Historique des Appels</h1><p class="page-subtitle">Tous les appels effectu√©s</p></div></div>
                <div class="filters-bar">
                    <div class="search-box"><span class="icon">üîç</span><input type="text" id="historiqueSearch" placeholder="Rechercher..." oninput="filterHistorique()"></div>
                    <select class="filter-select" id="historiqueFilter" onchange="filterHistorique()"><option value="">Tous les r√©sultats</option><option value="Oui">Int√©ress√©es</option><option value="Non">Pas int√©ress√©es</option><option value="Partiellement">Partiellement</option></select>
                </div>
                <div class="historique-grid" id="historiqueGrid"><div class="empty-state">Aucun appel enregistr√©</div></div>
            </div>

            <!-- NOTES -->
            <div class="page" id="page-notes">
                <div class="page-header"><div><h1 class="page-title">Notes d'√©quipe</h1><p class="page-subtitle">Tom, Mathieu & Claude</p></div></div>
                <div class="card note-form">
                    <div class="form-group" style="margin-bottom:16px"><label>Nouvelle note</label><textarea id="noteContent" placeholder="√âcrivez votre note..."></textarea></div>
                    <div class="note-form-footer">
                        <div style="display:flex;flex-direction:column;gap:12px">
                            <div><label style="font-size:12px;color:var(--text-muted);margin-bottom:8px;display:block">Assign√© √† :</label>
                                <div class="assignee-select">
                                    <button type="button" class="assignee-btn tom active" onclick="selectAssignee('tom',this)">üë®‚Äçüíº Tom</button>
                                    <button type="button" class="assignee-btn mathieu" onclick="selectAssignee('mathieu',this)">üë®‚Äçüíº Mathieu</button>
                                    <button type="button" class="assignee-btn both" onclick="selectAssignee('both',this)">üë• Les deux</button>
                                    <button type="button" class="assignee-btn claude" onclick="selectAssignee('claude',this)">ü§ñ Claude</button>
                                </div>
                            </div>
                            <div><label style="font-size:12px;color:var(--text-muted);margin-bottom:8px;display:block">Type :</label>
                                <div class="type-select">
                                    <button type="button" class="type-btn tache" onclick="selectNoteType('tache',this)">üî¥ T√¢che</button>
                                    <button type="button" class="type-btn idee" onclick="selectNoteType('idee',this)">üü° Id√©e</button>
                                    <button type="button" class="type-btn message active" onclick="selectNoteType('message',this)">üîµ Message</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addNote()">Ajouter</button>
                    </div>
                </div>
                <div class="notes-container" id="notesContainer"></div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
        <div class="modal" style="max-width:900px">
            <div class="modal-header"><h2 class="modal-title" id="modalTitle">D√©tails</h2><button type="button" class="modal-close" onclick="closeModal()">‚úï</button></div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <div class="modal-overlay" id="eventModalOverlay" onclick="if(event.target===this)closeEventModal()">
        <div class="modal" style="max-width:500px">
            <div class="modal-header"><h2 class="modal-title">Nouveau RDV</h2><button type="button" class="modal-close" onclick="closeEventModal()">‚úï</button></div>
            <div class="modal-body">
                <form id="eventForm" onsubmit="saveEvent(event)">
                    <div class="form-group"><label>Titre</label><input type="text" id="eventTitle" placeholder="Ex: RDV Auto-√©cole de Metz" required></div>
                    <div class="form-group autocomplete-wrapper"><label>Auto-√©cole</label><input type="text" id="eventAutoEcole" placeholder="Commencez √† taper..." oninput="showAutoEcoleAutocomplete(this, 'eventAutoEcoleList')"><div class="autocomplete-list" id="eventAutoEcoleList"></div></div>
                    <div class="form-group"><label>Date</label><input type="date" id="eventDate" required></div>
                    <div class="form-group"><label>Heure</label><input type="time" id="eventTime" required></div>
                    <div class="form-group"><label>Type</label><select id="eventType"><option value="rdv">üìÖ RDV client</option><option value="rappel">üìû Rappel</option><option value="autre">üìå Autre</option></select></div>
                    <div class="form-group"><label>Assign√© √†</label><select id="eventAssignee"><option value="Tom">Tom</option><option value="Mathieu">Mathieu</option><option value="Les deux">Les deux</option></select></div>
                    <div class="form-group"><label>Notes</label><textarea id="eventNotes" placeholder="D√©tails..."></textarea></div>
                    <button type="submit" class="btn btn-primary" style="width:100%">Ajouter</button>
                </form>
            </div>
        </div>
    </div>


    <script>
        const CONFIG = {
            password: 'Blonde54',
            webhooks: {
                scraping: 'https://n8n.srv1262234.hstgr.cloud/webhook/scraping-auto-ecoles',
                suivi: 'https://n8n.srv1262234.hstgr.cloud/webhook/suivi-appels-auto-ecoles',
                lecture: 'https://n8n.srv1262234.hstgr.cloud/webhook/lecture-auto-ecoles',
                // Nouveaux webhooks SaaS
                notesGet: 'https://n8n.srv1262234.hstgr.cloud/webhook/notes-tomya',
                notesPost: 'https://n8n.srv1262234.hstgr.cloud/webhook/notes-tomya',
                notesDelete: 'https://n8n.srv1262234.hstgr.cloud/webhook/notes-tomya',
                agendaGet: 'https://n8n.srv1262234.hstgr.cloud/webhook/agenda-tomya',
                agendaPost: 'https://n8n.srv1262234.hstgr.cloud/webhook/agenda-tomya',
                agendaDelete: 'https://n8n.srv1262234.hstgr.cloud/webhook/agenda-tomya',
                historiqueGet: 'https://n8n.srv1262234.hstgr.cloud/webhook/historique-tomya',
                historiquePost: 'https://n8n.srv1262234.hstgr.cloud/webhook/historique-tomya'
            }
        };

        const VILLES = ['Paris','Lyon','Marseille','Toulouse','Nice','Nantes','Strasbourg','Montpellier','Bordeaux','Lille','Rennes','Metz','Nancy','Jarny','Villers-l√®s-Nancy'];
        const MONTHS = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
        const DAYS = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];

        // Variables - initialis√©es vides, charg√©es depuis webhooks
        let autoEcolesData = [], filteredData = [];
        let notesData = [];
        let eventsData = [];
        let appelHistorique = [];
        let mediaRecorder = null, audioChunks = [], recordingInterval = null, recordingSeconds = 0;
        let currentFilter = null, selectedAssignee = 'tom', selectedNoteType = 'message', selectedCaller = 'Tom';
        let currentRecordingEcole = null, currentDate = new Date(), selectedDate = new Date();

        // AUTH
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (document.getElementById('passwordInput').value === CONFIG.password) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').classList.add('active');
                localStorage.setItem('tomya_auth', 'true');
                init();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        function logout() { localStorage.removeItem('tomya_auth'); location.reload(); }

        if (localStorage.getItem('tomya_auth') === 'true') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            init();
        }

        function init() {
            loadAutoEcoles();
            loadNotes();
            loadAgenda();
            loadHistorique();
            setupCalendarButtons();
        }

        // Setup Calendar Buttons
        function setupCalendarButtons() {
            document.getElementById('btnPrevMonth').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('btnNextMonth').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });
            document.getElementById('btnToday').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                currentDate = new Date();
                selectedDate = new Date();
                renderCalendar();
            });
        }

        // NAVIGATION
        function navigateTo(page) {
            document.querySelectorAll('#sidebarNav .nav-item').forEach(i => i.classList.remove('active'));
            const items = document.querySelectorAll('#sidebarNav .nav-item');
            items.forEach(item => {
                if (item.getAttribute('onclick')?.includes(page)) item.classList.add('active');
            });
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const pageEl = document.getElementById('page-' + page);
            if (pageEl) pageEl.classList.add('active');
        }

        function navigateWithFilter(filter) {
            currentFilter = filter;
            navigateTo('autoecoles');
            document.getElementById('filterStatus').value = filter === 'appele' ? 'appele' : '';
            document.getElementById('filterInteret').value = filter === 'interesse' ? 'Oui' : '';
            applyFilters();
        }

        // AUTOCOMPLETE
        function showAutoEcoleAutocomplete(input, listId) {
            const val = input.value.toLowerCase();
            const list = document.getElementById(listId);
            if (val.length < 2) { list.classList.remove('active'); return; }
            const matches = autoEcolesData.filter(e => e.nom?.toLowerCase().includes(val)).slice(0, 8);
            if (matches.length === 0) { list.classList.remove('active'); return; }
            list.innerHTML = matches.map(e => `<div class="autocomplete-item" onclick="selectAutoEcole('${e.nom.replace(/'/g,"\\'")}', '${input.id}', '${listId}')"><div>${e.nom}</div><div class="sub">${e.adresse || ''}</div></div>`).join('');
            list.classList.add('active');
        }

        function selectAutoEcole(nom, inputId, listId) {
            document.getElementById(inputId).value = nom;
            document.getElementById(listId).classList.remove('active');
        }

        function handleSearchInput(input) {
            const val = input.value.toLowerCase();
            const list = document.getElementById('searchAutocomplete');
            if (val.length < 2) { list.classList.remove('active'); applyFilters(); return; }
            const matches = autoEcolesData.filter(e => e.nom?.toLowerCase().includes(val)).slice(0, 6);
            if (matches.length > 0) {
                list.innerHTML = matches.map(e => `<div class="autocomplete-item" onclick="selectSearchAutoEcole('${e.nom.replace(/'/g,"\\'")}')"><div>${e.nom}</div><div class="sub">${e.adresse || ''}</div></div>`).join('');
                list.classList.add('active');
            } else { list.classList.remove('active'); }
            applyFilters();
        }

        function selectSearchAutoEcole(nom) {
            document.getElementById('searchInput').value = nom;
            document.getElementById('searchAutocomplete').classList.remove('active');
            applyFilters();
        }

        document.addEventListener('click', e => {
            if (!e.target.closest('.autocomplete-wrapper')) {
                document.querySelectorAll('.autocomplete-list').forEach(l => l.classList.remove('active'));
            }
        });

        // DATA - Auto-√©coles
        async function loadAutoEcoles() {
            try {
                const response = await fetch(CONFIG.webhooks.lecture);
                const data = await response.json();
                if (data.success) {
                    autoEcolesData = data.data || [];
                    filteredData = [...autoEcolesData];
                    updateStats(data.stats);
                    populateVilleFilter();
                    renderAutoEcoles(filteredData);
                }
            } catch (e) { document.getElementById('autoEcolesGrid').innerHTML = '<div class="empty-state">Erreur de chargement</div>'; }
        }

        function updateStats(stats) {
            document.getElementById('statTotal').textContent = stats?.total || 0;
            document.getElementById('statAppeles').textContent = stats?.appeles || 0;
            document.getElementById('statInteresses').textContent = stats?.interesses || 0;
            document.getElementById('statARappeler').textContent = stats?.a_rappeler || 0;
        }

        function populateVilleFilter() {
            const villesFromData = autoEcolesData.map(e => {
                if (!e.adresse) return null;
                for (const v of VILLES) { if (e.adresse.toLowerCase().includes(v.toLowerCase())) return v; }
                return null;
            }).filter(Boolean);
            const villes = [...new Set(villesFromData)].sort();
            document.getElementById('filterVille').innerHTML = '<option value="">Toutes villes</option>' + villes.map(v => `<option value="${v}">${v}</option>`).join('');
        }

        function renderAutoEcoles(data) {
            const grid = document.getElementById('autoEcolesGrid');
            if (!data || !data.length) { grid.innerHTML = '<div class="empty-state">Aucune auto-√©cole</div>'; return; }
            grid.innerHTML = data.map((e, i) => {
                const isAppele = e.appel_effectue === 'Oui';
                const isInteresse = e.interet === 'Oui';
                const isARappeler = e.prochaine_etape?.toLowerCase().includes('rappel');
                let sc = 'status-non-appele', st = 'Non appel√©e';
                if (isInteresse) { sc = 'status-interesse'; st = 'Int√©ress√©e'; }
                else if (isARappeler) { sc = 'status-a-rappeler'; st = '√Ä rappeler'; }
                else if (isAppele) { sc = 'status-appele'; st = 'Appel√©e'; }
                return `<div class="ecole-card" onclick="openEcoleDetail(${i})">
                    <div class="ecole-header"><div><div class="ecole-name">${e.nom||'Sans nom'}</div>${e.date_dernier_appel?`<div class="ecole-date">Dernier: ${e.date_dernier_appel}</div>`:''}${e.appele_par?`<div class="ecole-caller">Par: ${e.appele_par}</div>`:''}</div><span class="ecole-status ${sc}">${st}</span></div>
                    <div class="ecole-info">${e.adresse?`<div class="ecole-info-item">üìç ${e.adresse}</div>`:''}${e.telephone?`<div class="ecole-info-item">üìû ${e.telephone}</div>`:''}</div>
                    <div class="ecole-tags">${e.prochaine_etape?`<span class="ecole-tag">${e.prochaine_etape}</span>`:''}${e.nb_appels>0?`<span class="ecole-tag">${e.nb_appels} appel(s)</span>`:''}</div>
                </div>`;
            }).join('');
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const interet = document.getElementById('filterInteret').value;
            const ville = document.getElementById('filterVille').value;
            const caller = document.getElementById('filterCaller').value;
            
            filteredData = autoEcolesData.filter(e => {
                const mS = !search || e.nom?.toLowerCase().includes(search) || e.adresse?.toLowerCase().includes(search);
                const mSt = !status || (status === 'appele' && e.appel_effectue === 'Oui') || (status === 'non-appele' && e.appel_effectue !== 'Oui');
                const mI = !interet || e.interet?.includes(interet);
                const mV = !ville || e.adresse?.toLowerCase().includes(ville.toLowerCase());
                const mC = !caller || e.appele_par === caller;
                if (currentFilter === 'a-rappeler') return mS && e.prochaine_etape?.toLowerCase().includes('rappel');
                return mS && mSt && mI && mV && mC;
            });
            renderAutoEcoles(filteredData);
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterInteret').value = '';
            document.getElementById('filterVille').value = '';
            document.getElementById('filterCaller').value = '';
            currentFilter = null;
            filteredData = [...autoEcolesData];
            renderAutoEcoles(filteredData);
        }

        // MODAL
        function openEcoleDetail(i) {
            const e = filteredData[i]; if (!e) return;
            document.getElementById('modalTitle').textContent = e.nom || 'D√©tails';
            const notAppele = e.appel_effectue !== 'Oui';
            document.getElementById('modalBody').innerHTML = `
                ${notAppele?`<div style="margin-bottom:24px"><button type="button" class="btn btn-success" onclick="startRecordingForEcole('${(e.nom||'').replace(/'/g,"\\'")}')">üéôÔ∏è Enregistrer l'appel</button></div>`:''}
                <div class="detail-section"><div class="detail-section-title">Informations</div><div class="detail-grid">
                    <div class="detail-item"><span class="detail-label">Adresse</span><span class="detail-value">${e.adresse||'-'}</span></div>
                    <div class="detail-item"><span class="detail-label">T√©l√©phone</span><span class="detail-value">${e.telephone||'-'}</span></div>
                    <div class="detail-item"><span class="detail-label">Email</span><span class="detail-value">${e.email||'-'}</span></div>
                    <div class="detail-item"><span class="detail-label">Note Google</span><span class="detail-value">${e.note_google||'-'}</span></div>
                </div></div>
                <div class="detail-section"><div class="detail-section-title">Statut Commercial</div><div class="detail-grid">
                    <div class="detail-item"><span class="detail-label">Appel√©</span><span class="detail-value">${e.appel_effectue||'Non'}</span></div>
                    <div class="detail-item"><span class="detail-label">Par</span><span class="detail-value">${e.appele_par||'-'}</span></div>
                    <div class="detail-item"><span class="detail-label">Int√©r√™t</span><span class="detail-value">${e.interet||'-'}</span></div>
                    <div class="detail-item"><span class="detail-label">Prochaine √©tape</span><span class="detail-value">${e.prochaine_etape||'-'}</span></div>
                    <div class="detail-item"><span class="detail-label">Score</span><span class="detail-value">${e.score_appel||'-'}</span></div>
                    <div class="detail-item"><span class="detail-label">Humeur</span><span class="detail-value">${e.humeur_prospect||'-'}</span></div>
                </div></div>
                ${e.notes?`<div class="detail-section"><div class="detail-section-title">Notes</div><p>${e.notes}</p></div>`:''}
                ${e.transcription?`<div class="detail-section"><div class="detail-section-title">Transcription</div><div class="transcription-box">${e.transcription}</div></div>`:''}
            `;
            document.getElementById('modalOverlay').classList.add('active');
        }
        function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

        function startRecordingForEcole(name) {
            currentRecordingEcole = name;
            closeModal();
            navigateTo('recorder');
            document.getElementById('recorderEcoleInfo').style.display = 'inline-block';
            document.getElementById('recorderEcoleName').textContent = name;
        }

        // SCRAPING
        async function lancerScraping() {
            const btn = document.getElementById('scrapingBtn');
            const result = document.getElementById('scrapingResult');
            const ville = document.getElementById('scrapingVille').value.trim();
            const max = parseInt(document.getElementById('scrapingMax').value) || 20;

            if (!ville) {
                result.className = 'result-box error';
                result.innerHTML = '‚ùå Veuillez entrer une ville';
                result.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ Scraping en cours...';
            result.className = 'result-box';
            result.style.display = 'none';

            try {
                const response = await fetch(CONFIG.webhooks.scraping, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ville: ville, max_resultats: max })
                });
                const data = await response.json();
                result.className = 'result-box success';
                result.innerHTML = `‚úÖ ${data.stats?.new_items || data.new_items || 0} nouvelle(s) auto-√©cole(s) ajout√©e(s)<br><small>${data.stats?.duplicates_ignored || 0} doublon(s) ignor√©(s)</small>`;
                result.style.display = 'block';
                loadAutoEcoles();
            } catch (err) {
                result.className = 'result-box error';
                result.innerHTML = '‚ùå Erreur: ' + err.message;
                result.style.display = 'block';
            }

            btn.disabled = false;
            btn.textContent = 'üîç Lancer le Scraping';
        }

        // RECORDER
        function selectCaller(c, el) {
            selectedCaller = c;
            document.querySelectorAll('.caller-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        async function toggleRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') { stopRecording(); }
            else { startRecording(); }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => stream.getTracks().forEach(t => t.stop());
                mediaRecorder.start();
                document.getElementById('recorderBtn').classList.add('recording');
                document.getElementById('recorderBtn').textContent = '‚èπÔ∏è';
                document.getElementById('recorderStatus').textContent = 'Enregistrement...';
                document.getElementById('recorderWarning').classList.add('active');
                document.getElementById('recorderActions').style.display = 'none';
                recordingSeconds = 0;
                recordingInterval = setInterval(() => {
                    recordingSeconds++;
                    document.getElementById('recorderTime').textContent = `${Math.floor(recordingSeconds/60).toString().padStart(2,'0')}:${(recordingSeconds%60).toString().padStart(2,'0')}`;
                }, 1000);
            } catch (err) { alert('Erreur micro: ' + err.message); }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                document.getElementById('recorderBtn').classList.remove('recording');
                document.getElementById('recorderBtn').textContent = 'üéôÔ∏è';
                document.getElementById('recorderStatus').textContent = 'Termin√©';
                document.getElementById('recorderWarning').classList.remove('active');
                document.getElementById('recorderActions').style.display = 'flex';
            }
        }

        function cancelRecording() {
            audioChunks = [];
            currentRecordingEcole = null;
            document.getElementById('recorderEcoleInfo').style.display = 'none';
            document.getElementById('recorderStatus').textContent = 'Cliquez pour commencer';
            document.getElementById('recorderTime').textContent = '00:00';
            document.getElementById('recorderActions').style.display = 'none';
            document.getElementById('analysisResult').classList.remove('active');
        }

        async function sendRecording() {
            if (!audioChunks.length) return;
            const btn = document.querySelector('#recorderActions .btn-success');
            btn.disabled = true; btn.textContent = 'Analyse...';
            try {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const r = await fetch(CONFIG.webhooks.suivi, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            audio_base64: reader.result.split(',')[1],
                            audio_format: 'webm',
                            appele_par: selectedCaller,
                            ecole_preselect: currentRecordingEcole || ''
                        })
                    });
                    const data = await r.json();
                    displayAnalysisResult(data);
                    saveToHistorique(data);
                    loadAutoEcoles();
                    btn.disabled = false; btn.textContent = 'Envoyer pour Analyse';
                    document.getElementById('recorderActions').style.display = 'none';
                    document.getElementById('recorderStatus').textContent = 'Cliquez pour commencer';
                    document.getElementById('recorderTime').textContent = '00:00';
                    document.getElementById('recorderEcoleInfo').style.display = 'none';
                    currentRecordingEcole = null;
                };
                reader.readAsDataURL(blob);
            } catch (err) { alert('Erreur: ' + err.message); btn.disabled = false; btn.textContent = 'Envoyer pour Analyse'; }
        }

        // SAVE TO HISTORIQUE - WEBHOOK
        async function saveToHistorique(response) {
            const d = response.data || response;
            const appel = {
                id: Date.now().toString(),
                date: new Date().toLocaleDateString('fr-FR'),
                time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                ecole: d.nom_auto_ecole || currentRecordingEcole || 'Non identifi√©e',
                appele_par: selectedCaller,
                interet: d.interet || '-',
                notes: d.notes || '',
                prochaine_etape: d.prochaine_etape || '',
                score: d.score_appel || '-',
                humeur: d.humeur_prospect || '-',
                transcription: d.transcription || '',
                phrases_a_bannir: d.apprentissage?.phrases_a_bannir || d.phrases_a_bannir || '',
                bonnes_phrases: d.apprentissage?.bonnes_phrases || d.bonnes_phrases || '',
                conseils: d.apprentissage?.conseils_amelioration || d.conseils_amelioration || ''
            };
            
            // Sauvegarder dans Google Sheets via webhook
            try {
                await fetch(CONFIG.webhooks.historiquePost, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appel)
                });
            } catch (e) { console.error('Erreur sauvegarde historique:', e); }
            
            // Ajouter localement pour affichage imm√©diat
            appelHistorique.unshift(appel);
            renderHistorique();
        }

        function displayAnalysisResult(response) {
            const container = document.getElementById('analysisResult');
            const d = response.data || response;
            const rdv = (d.prochaine_etape || '').toLowerCase().includes('rdv');
            container.innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">R√©sultat de l'analyse</h3></div><div class="card-body">
                <div class="analysis-header"><div class="analysis-icon">‚úì</div><div><div class="analysis-title">${d.nom_auto_ecole || 'Non identifi√©e'}</div><div class="analysis-subtitle">Appel√© par: ${selectedCaller}</div></div></div>
                ${rdv?`<div class="rdv-badge" onclick="autoAddRdv('${(d.nom_auto_ecole||'').replace(/'/g,"\\'")}','${(d.prochaine_etape||'').replace(/'/g,"\\'")}')">üìÖ RDV d√©tect√© ! Cliquez pour ajouter √† l'agenda</div>`:''}
                <div class="analysis-grid" style="margin-top:20px">
                    <div class="analysis-section"><div class="analysis-section-title">R√©sultat</div><p><strong>Int√©r√™t:</strong> ${d.interet||'-'}</p><p><strong>Prochaine √©tape:</strong> ${d.prochaine_etape||'-'}</p><p><strong>Score:</strong> ${d.score_appel||'-'}</p></div>
                    <div class="analysis-section"><div class="analysis-section-title">Notes</div><p>${d.notes||'-'}</p></div>
                </div>
            </div></div>`;
            container.classList.add('active');
        }

        function autoAddRdv(ecole, etape) {
            const dm = etape.match(/(\d{1,2})[\/\-](\d{1,2})/);
            const tm = etape.match(/(\d{1,2})[h:](\d{0,2})/);
            document.getElementById('eventTitle').value = 'RDV ' + ecole;
            document.getElementById('eventAutoEcole').value = ecole;
            document.getElementById('eventDate').value = dm ? `2026-${dm[2].padStart(2,'0')}-${dm[1].padStart(2,'0')}` : formatDate(new Date());
            document.getElementById('eventTime').value = tm ? `${tm[1].padStart(2,'0')}:${(tm[2]||'00').padStart(2,'0')}` : '14:00';
            document.getElementById('eventAssignee').value = selectedCaller;
            document.getElementById('eventModalOverlay').classList.add('active');
        }

        // ===== HISTORIQUE - DEPUIS GOOGLE SHEETS =====
        async function loadHistorique() {
            try {
                const response = await fetch(CONFIG.webhooks.historiqueGet);
                const data = await response.json();
                if (data.success) {
                    appelHistorique = data.data || [];
                    renderHistorique();
                }
            } catch (e) { 
                console.error('Erreur chargement historique:', e);
                renderHistorique();
            }
        }

        function renderHistorique() {
            const grid = document.getElementById('historiqueGrid');
            if (!appelHistorique.length) { grid.innerHTML = '<div class="empty-state">Aucun appel enregistr√©</div>'; return; }
            grid.innerHTML = appelHistorique.map(a => {
                let badgeClass = 'partiel';
                if (a.interet === 'Oui') badgeClass = 'interesse';
                else if (a.interet === 'Non') badgeClass = 'non-interesse';
                return `<div class="appel-card" onclick="openAppelDetail('${a.id}')">
                    <div class="appel-header"><div><div class="appel-ecole">${a.ecole}</div><div class="appel-date">${a.date} √† ${a.time}</div></div><span class="appel-badge ${badgeClass}">${a.interet}</span></div>
                    <div class="appel-meta"><div class="appel-meta-item">üë§ ${a.appele_par}</div><div class="appel-meta-item">‚≠ê ${a.score}</div><div class="appel-meta-item">üòä ${a.humeur}</div></div>
                    ${a.notes?`<div class="appel-notes">${a.notes.substring(0,150)}${a.notes.length>150?'...':''}</div>`:''}
                </div>`;
            }).join('');
        }

        function filterHistorique() {
            const search = document.getElementById('historiqueSearch').value.toLowerCase();
            const filter = document.getElementById('historiqueFilter').value;
            const filtered = appelHistorique.filter(a => {
                const mS = !search || a.ecole?.toLowerCase().includes(search);
                const mF = !filter || a.interet === filter;
                return mS && mF;
            });
            const grid = document.getElementById('historiqueGrid');
            if (!filtered.length) { grid.innerHTML = '<div class="empty-state">Aucun appel trouv√©</div>'; return; }
            grid.innerHTML = filtered.map(a => {
                let badgeClass = 'partiel';
                if (a.interet === 'Oui') badgeClass = 'interesse';
                else if (a.interet === 'Non') badgeClass = 'non-interesse';
                return `<div class="appel-card" onclick="openAppelDetail('${a.id}')">
                    <div class="appel-header"><div><div class="appel-ecole">${a.ecole}</div><div class="appel-date">${a.date} √† ${a.time}</div></div><span class="appel-badge ${badgeClass}">${a.interet}</span></div>
                    <div class="appel-meta"><div class="appel-meta-item">üë§ ${a.appele_par}</div><div class="appel-meta-item">‚≠ê ${a.score}</div></div>
                </div>`;
            }).join('');
        }

        function openAppelDetail(id) {
            const a = appelHistorique.find(x => x.id === id);
            if (!a) return;
            document.getElementById('modalTitle').textContent = `Appel - ${a.ecole}`;
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-section"><div class="detail-section-title">Informations</div><div class="detail-grid">
                    <div class="detail-item"><span class="detail-label">Date</span><span class="detail-value">${a.date} √† ${a.time}</span></div>
                    <div class="detail-item"><span class="detail-label">Appel√© par</span><span class="detail-value">${a.appele_par}</span></div>
                    <div class="detail-item"><span class="detail-label">Int√©r√™t</span><span class="detail-value">${a.interet}</span></div>
                    <div class="detail-item"><span class="detail-label">Score</span><span class="detail-value">${a.score}</span></div>
                    <div class="detail-item"><span class="detail-label">Humeur</span><span class="detail-value">${a.humeur}</span></div>
                    <div class="detail-item"><span class="detail-label">Prochaine √©tape</span><span class="detail-value">${a.prochaine_etape||'-'}</span></div>
                </div></div>
                ${a.notes?`<div class="detail-section"><div class="detail-section-title">Notes</div><p>${a.notes}</p></div>`:''}
                ${a.transcription?`<div class="detail-section"><div class="detail-section-title">Transcription</div><div class="transcription-box">${a.transcription}</div></div>`:''}
                ${(a.phrases_a_bannir||a.bonnes_phrases||a.conseils)?`<div class="detail-section"><div class="detail-section-title">Apprentissage IA</div>
                    ${a.phrases_a_bannir?`<p><strong style="color:var(--danger)">üö´ √Ä bannir:</strong> ${a.phrases_a_bannir}</p>`:''}
                    ${a.bonnes_phrases?`<p style="margin-top:12px"><strong style="color:var(--success)">‚úÖ Bonnes phrases:</strong> ${a.bonnes_phrases}</p>`:''}
                    ${a.conseils?`<p style="margin-top:12px"><strong style="color:var(--accent)">üí° Conseils:</strong> ${a.conseils}</p>`:''}
                </div>`:''}
            `;
            document.getElementById('modalOverlay').classList.add('active');
        }

        // ===== CALENDAR / AGENDA - DEPUIS GOOGLE SHEETS =====
        async function loadAgenda() {
            try {
                const response = await fetch(CONFIG.webhooks.agendaGet);
                const data = await response.json();
                if (data.success) {
                    eventsData = data.data || [];
                    renderCalendar();
                }
            } catch (e) { 
                console.error('Erreur chargement agenda:', e);
                renderCalendar();
            }
        }

        function renderCalendar() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth();
            document.getElementById('calendarMonth').textContent = `${MONTHS[m]} ${y}`;
            const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
            const start = (first.getDay() + 6) % 7, days = last.getDate();
            const today = new Date();
            let html = '';
            const prev = new Date(y, m, 0);
            for (let i = start - 1; i >= 0; i--) {
                const d = prev.getDate() - i;
                const py = m === 0 ? y - 1 : y;
                const pm = m === 0 ? 11 : m - 1;
                html += `<div class="calendar-day other-month" onclick="selectDate(${py},${pm},${d})">${d}</div>`;
            }
            for (let d = 1; d <= days; d++) {
                const date = new Date(y, m, d);
                const isT = date.toDateString() === today.toDateString();
                const isS = date.toDateString() === selectedDate.toDateString();
                const hasE = eventsData.some(e => e.date === formatDate(date));
                html += `<div class="calendar-day${isT?' today':''}${isS?' selected':''}${hasE?' has-event':''}" onclick="selectDate(${y},${m},${d})">${d}</div>`;
            }
            const remaining = 42 - start - days;
            for (let i = 1; i <= remaining; i++) {
                const ny = m === 11 ? y + 1 : y;
                const nm = m === 11 ? 0 : m + 1;
                html += `<div class="calendar-day other-month" onclick="selectDate(${ny},${nm},${i})">${i}</div>`;
            }
            document.getElementById('calendarDays').innerHTML = html;
            renderEvents();
        }

        function selectDate(y, m, d) {
            selectedDate = new Date(y, m, d);
            currentDate = new Date(y, m, 1);
            renderCalendar();
        }

        function formatDate(d) { return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`; }

        function renderEvents() {
            const ds = formatDate(selectedDate);
            const evts = eventsData.filter(e => e.date === ds).sort((a,b) => (a.time||'').localeCompare(b.time||''));
            document.getElementById('eventsDate').textContent = `${DAYS[selectedDate.getDay()]} ${selectedDate.getDate()} ${MONTHS[selectedDate.getMonth()]}`;
            document.getElementById('eventsCount').textContent = evts.length ? `${evts.length} √©v√©nement(s)` : '';
            document.getElementById('eventsList').innerHTML = evts.length ? evts.map(e => `<div class="event-card ${e.type}"><div class="event-time">${e.time} ‚Ä¢ ${e.assignee||'-'}</div><div class="event-title">${e.title}</div>${e.auto_ecole?`<div class="event-desc">üè´ ${e.auto_ecole}</div>`:''}${e.notes?`<div class="event-desc">${e.notes}</div>`:''}<div class="event-actions"><button type="button" class="btn btn-danger btn-xs" onclick="deleteEvent('${e.id}')">Supprimer</button></div></div>`).join('') : '<div class="events-empty">Aucun √©v√©nement ce jour</div>';
        }

        async function deleteEvent(id) {
            try {
                await fetch(CONFIG.webhooks.agendaDelete + '?id=' + id, { method: 'DELETE' });
            } catch (e) { console.error('Erreur suppression event:', e); }
            eventsData = eventsData.filter(e => e.id !== id);
            renderCalendar();
        }

        function openAddEventModal() { document.getElementById('eventDate').value = formatDate(selectedDate); document.getElementById('eventModalOverlay').classList.add('active'); }
        function closeEventModal() { document.getElementById('eventModalOverlay').classList.remove('active'); document.getElementById('eventForm').reset(); }

        async function saveEvent(e) {
            e.preventDefault();
            const evt = { 
                id: Date.now().toString(), 
                title: document.getElementById('eventTitle').value, 
                auto_ecole: document.getElementById('eventAutoEcole').value, 
                date: document.getElementById('eventDate').value, 
                time: document.getElementById('eventTime').value, 
                type: document.getElementById('eventType').value, 
                assignee: document.getElementById('eventAssignee').value, 
                notes: document.getElementById('eventNotes').value 
            };
            
            // Sauvegarder dans Google Sheets
            try {
                await fetch(CONFIG.webhooks.agendaPost, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(evt)
                });
            } catch (err) { console.error('Erreur sauvegarde agenda:', err); }
            
            eventsData.push(evt);
            closeEventModal();
            renderCalendar();
        }

        // ===== NOTES - DEPUIS GOOGLE SHEETS =====
        async function loadNotes() {
            try {
                const response = await fetch(CONFIG.webhooks.notesGet);
                const data = await response.json();
                if (data.success) {
                    notesData = data.data || [];
                    renderNotes();
                }
            } catch (e) { 
                console.error('Erreur chargement notes:', e);
                renderNotes();
            }
        }

        function selectAssignee(a, el) { selectedAssignee = a; document.querySelectorAll('.assignee-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); }
        function selectNoteType(t, el) { selectedNoteType = t; document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); }
        
        async function addNote() {
            const c = document.getElementById('noteContent').value.trim();
            if (!c) return;
            const note = { 
                id: Date.now().toString(), 
                content: c, 
                assignee: selectedAssignee, 
                type: selectedNoteType, 
                date: new Date().toLocaleDateString('fr-FR'), 
                time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) 
            };
            
            // Sauvegarder dans Google Sheets
            try {
                await fetch(CONFIG.webhooks.notesPost, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(note)
                });
            } catch (err) { console.error('Erreur sauvegarde note:', err); }
            
            notesData.unshift(note);
            document.getElementById('noteContent').value = '';
            renderNotes();
        }
        
        async function deleteNote(id) {
            try {
                await fetch(CONFIG.webhooks.notesDelete + '?id=' + id, { method: 'DELETE' });
            } catch (e) { console.error('Erreur suppression note:', e); }
            notesData = notesData.filter(n => n.id !== id);
            renderNotes();
        }
        
        function renderNotes() {
            const c = document.getElementById('notesContainer');
            if (!notesData.length) { c.innerHTML = '<div class="empty-state">Aucune note</div>'; return; }
            const names = { tom: 'Tom', mathieu: 'Mathieu', both: 'Tom & Mathieu', claude: 'Claude' };
            const types = { tache: 'T√¢che', idee: 'Id√©e', message: 'Message' };
            c.innerHTML = notesData.map(n => `<div class="note-card type-${n.type||'message'}"><div class="note-header"><div class="note-author"><div class="note-avatar ${n.assignee}">${n.assignee==='both'?'üë•':n.assignee==='claude'?'ü§ñ':(n.assignee||'t')[0].toUpperCase()}</div><span class="note-name">${names[n.assignee]||n.assignee}</span></div><div class="note-meta"><span class="note-type ${n.type||'message'}">${types[n.type]||'Message'}</span><span class="note-date">${n.date} ${n.time}</span></div></div><div class="note-content">${n.content}</div><div class="note-actions"><button type="button" class="btn btn-danger btn-xs" onclick="deleteNote('${n.id}')">Supprimer</button></div></div>`).join('');
        }
    </script>
</body>
</html>
